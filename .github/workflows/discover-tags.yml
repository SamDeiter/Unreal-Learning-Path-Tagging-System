name: Discover New Tags

on:
  schedule:
    # Run weekly on Monday at 6 AM UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      queries:
        description: "Custom search queries (comma-separated)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-tags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install python-dotenv

      - name: Run tag discovery
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          # Create .env for the script
          echo "YOUTUBE_API_KEY=$YOUTUBE_API_KEY" > .env

          # Run discovery with default or custom queries
          if [ -n "${{ github.event.inputs.queries }}" ]; then
            # Custom queries from workflow dispatch
            IFS=',' read -ra QUERIES <<< "${{ github.event.inputs.queries }}"
            for query in "${QUERIES[@]}"; do
              python -m ingestion.tag_discovery research "$query"
            done
          else
            # Default: run full research session
            python -m ingestion.tag_discovery research-all
          fi

          # Clean up .env
          rm .env

      - name: Check for new candidates
        id: check-changes
        run: |
          if git diff --name-only | grep -q "tag_candidates.json"; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìã New tag candidates discovered!"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No new tags discovered."
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add new tag candidates from automated discovery"
          title: "üè∑Ô∏è New Tag Candidates Discovered"
          body: |
            ## Automated Tag Discovery

            This PR was created by the weekly tag discovery workflow.

            ### What happened:
            - Searched YouTube for trending UE5 problems
            - Extracted concepts using TF-IDF and pattern matching
            - Found new potential tags

            ### Review needed:
            1. Check `tags/tag_candidates.json` for new candidates
            2. Approve/reject using CLI:
               ```bash
               python -m ingestion.tag_discovery list
               python -m ingestion.tag_discovery approve <term>
               ```
            3. Add approved tags to `tags/tags.json`

            ---
            *Generated by [Discover Tags Workflow](.github/workflows/discover-tags.yml)*
          branch: auto/tag-discovery
          delete-branch: true
          labels: |
            automation
            tags
