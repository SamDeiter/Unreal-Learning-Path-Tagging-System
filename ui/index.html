<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UE5 Learning Path Builder</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <!-- xAPI (Tin Can) Support for LMS Integration -->
    <script src="js/xapiwrapper.min.js"></script>
    <script src="js/tracking.js"></script>
    <script>
      // Firebase configuration for ue5-learning-paths project
      const firebaseConfig = {
        apiKey: "REDACTED_FIREBASE_API_KEY",
        authDomain: "ue5-learning-paths.firebaseapp.com",
        projectId: "ue5-learning-paths",
        storageBucket: "ue5-learning-paths.firebasestorage.app",
        messagingSenderId: "687715963885",
        appId: "1:687715963885:web:d34c7a26f7471ff0d54de4",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Rate limiting - max 10 queries per 5 minutes
      const queryHistory = [];
      const RATE_LIMIT = 10;
      const RATE_WINDOW_MS = 5 * 60 * 1000; // 5 minutes

      function isRateLimited() {
        const now = Date.now();
        // Remove old entries
        while (
          queryHistory.length > 0 &&
          queryHistory[0] < now - RATE_WINDOW_MS
        ) {
          queryHistory.shift();
        }
        return queryHistory.length >= RATE_LIMIT;
      }

      // Sanitize input - only allow safe characters
      function sanitizeQuery(query) {
        return query
          .substring(0, 200) // Max length
          .replace(/[<>{}()\[\]\\\/'"`;]/g, "") // Remove dangerous chars
          .trim();
      }

      // Log a query to Firestore for trend tracking
      async function logQuery(query, hasResults) {
        if (isRateLimited()) {
          console.log("Rate limited - skipping log");
          return;
        }

        queryHistory.push(Date.now());
        const sanitized = sanitizeQuery(query);
        if (!sanitized) return;

        try {
          await db.collection("query_logs").add({
            query: sanitized.toLowerCase(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            hasResults: hasResults,
          });
        } catch (e) {
          console.log("Query logging disabled or failed:", e.message);
        }

        // Also track via unified Tracker (works in both standalone and LMS modes)
        if (typeof Tracker !== "undefined") {
          Tracker.trackQuery(sanitized, []);
        }
      }
    </script>
    <style>
      :root {
        --primary: #0ea5e9;
        --primary-dark: #0284c7;
        --success: #22c55e;
        --warning: #f59e0b;
        --error: #ef4444;
        --purple: #8b5cf6;
        --bg: #0f172a;
        --bg-card: #1e293b;
        --bg-hover: #334155;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --border: #334155;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Header */
      header {
        text-align: center;
        margin-bottom: 3rem;
      }

      h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--primary), var(--purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
      }

      /* Search */
      .search-section {
        background: var(--bg-card);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .search-box {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .search-input {
        flex: 1;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 0.75rem;
        color: var(--text);
        transition: border-color 0.2s;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .search-btn {
        padding: 1rem 2rem;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        border: none;
        border-radius: 0.75rem;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
      }
      /* Basket UI Styles */
      .basket-title { font-size: 1.5rem; color: var(--text); margin-bottom: 0.25rem; }
      .basket-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
      .input-methods { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
      .input-method-btn { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem 1.5rem; background: var(--bg); border: 1px dashed var(--border); border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; flex: 1; min-width: 100px; }
      .input-method-btn:hover { border-style: solid; }
      .input-method-btn.text-btn:hover, .input-method-btn.text-btn.active { border-color: var(--primary); background: rgba(14, 165, 233, 0.1); }
      .input-method-btn.log-btn:hover, .input-method-btn.log-btn.active { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
      .input-method-btn.screenshot-btn:hover, .input-method-btn.screenshot-btn.active { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
      .method-icon { font-size: 1.5rem; }
      .method-label { color: var(--text-muted); font-size: 0.8rem; }
      .input-panel { display: flex; gap: 0.5rem; margin-bottom: 1rem; animation: slideDown 0.2s ease; }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .basket-input { flex: 1; padding: 0.75rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.9rem; }
      .basket-input:focus { outline: none; border-color: var(--primary); }
      .basket-textarea { flex: 1; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.8rem; font-family: monospace; resize: vertical; }
      .basket-textarea:focus { outline: none; border-color: #a855f7; }
      .add-ingredient-btn { padding: 0.75rem 1rem; background: var(--primary); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer; white-space: nowrap; }
      .add-ingredient-btn.log-add { background: #a855f7; }
      .add-ingredient-btn.screenshot-add { background: #22c55e; }
      .add-ingredient-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .ingredient-basket { background: var(--bg); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; min-height: 60px; margin-bottom: 1rem; }
      .basket-empty { color: var(--text-muted); font-size: 0.875rem; text-align: center; padding: 0.5rem; }
      .ingredient-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
      .ingredient-chip { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; border-radius: 2rem; font-size: 0.8rem; animation: fadeIn 0.2s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
      .ingredient-chip.text-chip { background: rgba(14, 165, 233, 0.15); border: 1px solid rgba(14, 165, 233, 0.3); color: var(--primary); }
      .ingredient-chip.log-chip { background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); color: #a855f7; }
      .ingredient-chip.screenshot-chip { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; }
      .chip-remove { background: none; border: none; color: inherit; cursor: pointer; opacity: 0.7; font-size: 0.7rem; padding: 0; }
      .chip-remove:hover { opacity: 1; }
      .generate-btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; border-radius: 0.75rem; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem; }
      .generate-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4); }
      .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .screenshot-dropzone { border: 2px dashed var(--border); border-radius: 0.5rem; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg); flex: 1; }
      .screenshot-dropzone:hover, .screenshot-dropzone.dragover { border-color: #22c55e; background: rgba(34, 197, 94, 0.05); }
      .dropzone-content { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
      .dropzone-icon { font-size: 1.5rem; }
      .dropzone-text { color: var(--text-muted); font-size: 0.8rem; }
      .screenshot-preview { position: relative; display: inline-block; }
      .screenshot-preview img { max-width: 100%; max-height: 100px; border-radius: 0.5rem; }
      .remove-preview { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: #ef4444; border: none; color: white; cursor: pointer; font-size: 0.6rem; }



      .examples {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .example-btn {
        padding: 0.5rem 1rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 2rem;
        color: var(--text-muted);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .example-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
        border-color: var(--primary);
      }

      /* Crash Log Section */
      .crashlog-section {
        margin-top: 1rem;
      }

      .crashlog-toggle {
        background: transparent;
        border: 1px dashed var(--border);
        color: var(--text-muted);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .crashlog-toggle:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(14, 165, 233, 0.05);
      }

      .crashlog-container {
        margin-top: 0.75rem;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .crashlog-textarea {
        width: 100%;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--text);
        padding: 1rem;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 0.8rem;
        resize: vertical;
        min-height: 100px;
      }

      .crashlog-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
      }

      .crashlog-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .extracted-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
      }

      .extracted-tag {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: rgba(168, 85, 247, 0.2);
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 0.25rem;
        color: #a855f7;
      }

      .crashlog-parse-btn {
        background: linear-gradient(135deg, #a855f7, #8b5cf6);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .crashlog-parse-btn:hover {
        transform: translateY(-2px);
      }

      /* Screenshot Upload Section */
      .screenshot-section {
        margin-top: 0.5rem;
      }

      .screenshot-toggle {
        background: transparent;
        border: 1px dashed var(--border);
        color: var(--text-muted);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .screenshot-toggle:hover {
        border-color: #22c55e;
        color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
      }

      .screenshot-container {
        margin-top: 0.75rem;
        animation: slideDown 0.3s ease;
      }

      .screenshot-dropzone {
        border: 2px dashed var(--border);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg);
        position: relative;
      }

      .screenshot-dropzone:hover,
      .screenshot-dropzone.dragover {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
      }

      .dropzone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .dropzone-icon {
        font-size: 2rem;
      }

      .dropzone-text {
        color: var(--text);
        font-weight: 500;
      }

      .dropzone-hint {
        color: var(--text-muted);
        font-size: 0.75rem;
      }

      .screenshot-preview {
        position: relative;
        display: inline-block;
      }

      .screenshot-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
      }

      .remove-screenshot {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ef4444;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .screenshot-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .screenshot-analyze-btn {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          opacity 0.2s;
      }

      .screenshot-analyze-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .screenshot-analyze-btn:not(:disabled):hover {
        transform: translateY(-2px);
      }
      .gallery-section {
        background: var(--bg-card);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }

      .gallery-card {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        padding: 1.5rem 1rem;
        background: linear-gradient(
          135deg,
          rgba(14, 165, 233, 0.1),
          rgba(139, 92, 246, 0.1)
        );
        border: 1px solid var(--border);
        border-radius: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        min-height: 140px;
      }

      .gallery-card:hover {
        transform: translateY(-4px);
        border-color: var(--primary);
        box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
        background: linear-gradient(
          135deg,
          rgba(14, 165, 233, 0.2),
          rgba(139, 92, 246, 0.2)
        );
      }

      .gallery-icon {
        font-size: 2rem;
        line-height: 1;
      }

      .gallery-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
        line-height: 1.3;
      }

      .gallery-steps {
        font-size: 0.75rem;
        color: var(--text-muted);
        padding: 0.25rem 0.75rem;
        background: var(--bg);
        border-radius: 1rem;
      }

      .popular-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        background: linear-gradient(135deg, #f97316, #ef4444);
        color: white;
        border-radius: 0.5rem;
        font-weight: 600;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 3rem;
        display: none;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-right-color: var(--purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }

      .loading-text {
        font-size: 1.2rem;
        color: var(--text);
        margin-bottom: 0.5rem;
      }

      .loading-subtext {
        color: var(--text-muted);
        font-size: 0.9rem;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
      }

      /* Path Display */
      .path-section {
        display: none;
      }

      .path-section.active {
        display: block;
      }

      .path-header {
        background: var(--bg-card);
        border-radius: 1rem;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
      }

      .path-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .path-query {
        color: var(--text-muted);
        margin-bottom: 1rem;
      }

      .path-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .tag {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
      }

      /* Back Button */
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--text-muted);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
      }

      .back-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
        border-color: var(--primary);
      }

      /* Steps */
      .steps-container {
        display: grid;
        gap: 1.5rem;
      }

      .step-card {
        background: var(--bg-card);
        border-radius: 1rem;
        overflow: hidden;
        transition: transform 0.2s;
      }

      .step-card:hover {
        transform: translateY(-4px);
      }

      .step-header {
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
      }

      .step-number {
        width: 40px;
        height: 40px;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      /* Step number colors by type */
      .step-card[data-type="foundations"] .step-number {
        border-color: var(--primary);
        color: var(--primary);
      }
      .step-card[data-type="diagnostics"] .step-number {
        border-color: var(--warning);
        color: var(--warning);
      }
      .step-card[data-type="resolution"] .step-number {
        border-color: var(--success);
        color: var(--success);
      }
      .step-card[data-type="prevention"] .step-number {
        border-color: var(--purple);
        color: var(--purple);
      }

      /* Completed step number */
      .step-card.completed .step-number {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }
      .step-card.completed .step-number::after {
        content: "‚úì";
        position: absolute;
      }
      .step-card.completed .step-number span {
        visibility: hidden;
      }

      .step-type {
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .step-type.foundations {
        background: var(--primary);
      }
      .step-type.diagnostics {
        background: var(--warning);
        color: #000;
      }
      .step-type.resolution {
        background: var(--success);
      }
      .step-type.prevention {
        background: var(--purple);
      }

      .step-title {
        flex: 1;
        font-size: 1.1rem;
      }

      .step-toggle {
        font-size: 1.5rem;
        transition: transform 0.3s;
      }

      .step-card.expanded .step-toggle {
        transform: rotate(180deg);
      }

      .step-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .step-card.expanded .step-content {
        max-height: 1000px;
      }

      .step-description {
        padding: 0 1.5rem 1rem;
        color: var(--text-muted);
      }

      .content-list {
        padding: 0 1.5rem 1.5rem;
        display: grid;
        gap: 1rem;
      }

      .content-item {
        background: var(--bg);
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        border-left: 4px solid var(--primary);
        display: flex;
        gap: 1rem;
      }

      .content-type {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 0.25rem;
      }

      .content-title {
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .content-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.9rem;
      }

      .content-link:hover {
        text-decoration: underline;
      }

      .content-thumbnail {
        width: 120px;
        height: 68px;
        object-fit: cover;
        border-radius: 0.5rem;
        flex-shrink: 0;
      }

      .content-details {
        flex: 1;
      }

      .content-description {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0.25rem 0;
        line-height: 1.6;
      }

      .content-description strong {
        color: var(--text);
        font-weight: 600;
      }

      .content-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.5rem;
      }

      .content-thumbnail {
        cursor: pointer;
        transition: transform 0.2s;
      }

      .content-thumbnail:hover {
        transform: scale(1.05);
      }

      /* Action Box */
      .action-box {
        background: linear-gradient(
          135deg,
          rgba(14, 165, 233, 0.15),
          rgba(168, 85, 247, 0.1)
        );
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
      }

      .action-box .action-icon {
        font-size: 1.5rem;
      }

      .action-box .action-text {
        font-weight: 500;
        color: var(--text);
      }

      .action-box .action-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--primary);
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
      }

      /* Progress */
      .progress-section {
        background: var(--bg-card);
        border-radius: 1rem;
        padding: 1.5rem 2rem;
        margin-top: 2rem;
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .progress-text {
        font-weight: 500;
      }

      .progress-bar {
        flex: 1;
        height: 10px;
        background: var(--border);
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--success));
        width: 0%;
        transition: width 0.5s;
      }

      .complete-btn {
        padding: 0.75rem 1.5rem;
        background: var(--success);
        border: none;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        cursor: pointer;
      }

      /* Video Modal */
      .video-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .video-modal.active {
        display: flex;
      }

      .video-container {
        width: 90%;
        max-width: 1000px;
        position: relative;
      }

      .video-container iframe {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 0.75rem;
        border: none;
      }

      .video-close {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .video-close:hover {
        opacity: 1;
      }

      .watch-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #ff0000, #cc0000);
        border: none;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        cursor: pointer;
        margin-right: 0.5rem;
        transition: transform 0.2s;
      }

      .watch-btn:hover {
        transform: scale(1.05);
      }

      /* Footer */
      .site-footer {
        text-align: center;
        padding: 2rem;
        margin-top: 2rem;
        border-top: 1px solid var(--border);
        color: var(--text-muted);
      }

      .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .footer-main p {
        margin: 0;
        font-size: 0.9rem;
      }

      .footer-sub {
        font-size: 0.8rem !important;
        opacity: 0.7;
      }

      .footer-meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .build-info {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 0.25rem;
        font-family: monospace;
        color: var(--text-muted);
      }

      .env-badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .env-badge.local,
      #envBadge {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .env-badge.production {
        background: rgba(14, 165, 233, 0.2);
        color: #0ea5e9;
        border: 1px solid rgba(14, 165, 233, 0.3);
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.8rem;
      }

      .footer-links a {
        color: var(--primary);
        text-decoration: none;
      }

      .footer-links a:hover {
        text-decoration: underline;
      }

      .footer-links span {
        color: var(--text-muted);
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üéÆ UE5 Learning Path Builder</h1>
        <p class="subtitle">
          Enter your problem, get a structured learning path from existing
          content
        </p>
      </header>

      <section class="search-section">
        <h2 class="basket-title">üß∫ Build Your Problem</h2>
        <p class="basket-subtitle">Add ingredients to describe your issue, then generate a learning path</p>
        
        <!-- Hidden queryInput for compatibility -->
        <input type="hidden" id="queryInput" value="">
        
        <!-- Input Method Buttons -->
        <div class="input-methods">
          <button class="input-method-btn text-btn" onclick="showInputPanel('text')">
            <span class="method-icon">üìù</span>
            <span class="method-label">Describe Issue</span>
          </button>
          <button class="input-method-btn log-btn" onclick="showInputPanel('log')">
            <span class="method-icon">üìã</span>
            <span class="method-label">Paste Error Log</span>
          </button>
          <button class="input-method-btn screenshot-btn" onclick="showInputPanel('screenshot')">
            <span class="method-icon">üì∑</span>
            <span class="method-label">Add Screenshot</span>
          </button>
        </div>

        <!-- Expandable Input Panels -->
        <div class="input-panels">
          <div class="input-panel" id="textPanel" style="display: none;">
            <input type="text" class="basket-input" id="textInput" placeholder="Describe your UE5 problem..."/>
            <button class="add-ingredient-btn" onclick="addTextIngredient()">+ Add</button>
          </div>
          <div class="input-panel" id="logPanel" style="display: none;">
            <textarea id="logInput" class="basket-textarea" placeholder="Paste crash log or error output..." rows="4"></textarea>
            <button class="add-ingredient-btn log-add" onclick="addLogIngredient()">+ Extract & Add</button>
          </div>
          <div class="input-panel" id="screenshotPanel" style="display: none;">
            <div class="screenshot-dropzone" id="screenshotDropzone" onclick="document.getElementById('screenshotInput').click()">
              <input type="file" id="screenshotInput" accept="image/*" style="display: none;" onchange="handleScreenshotSelect(event)">
              <div class="dropzone-content" id="dropzoneContent">
                <span class="dropzone-icon">üìÅ</span>
                <span class="dropzone-text">Click or drag to upload</span>
              </div>
              <div class="screenshot-preview" id="screenshotPreview" style="display: none;">
                <img id="previewImage" alt="Preview">
                <button class="remove-preview" onclick="event.stopPropagation(); clearScreenshotPreview()">‚úï</button>
              </div>
            </div>
            <button class="add-ingredient-btn screenshot-add" id="addScreenshotBtn" onclick="addScreenshotIngredient()" disabled>+ Add Screenshot</button>
          </div>
        </div>

        <!-- Ingredient Basket -->
        <div class="ingredient-basket" id="ingredientBasket">
          <div class="basket-empty" id="basketEmpty"><span>No ingredients yet ‚Äî add something above!</span></div>
          <div class="ingredient-chips" id="ingredientChips"></div>
        </div>

        <!-- Generate Button -->
        <button class="generate-btn" id="generateBtn" onclick="generateFromBasket()" disabled>üöÄ Generate Learning Path</button>

        <!-- Quick Examples -->
        <div class="examples">
          <span style="color: var(--text-muted); margin-right: 0.5rem">Quick add:</span>
          <button class="example-btn" onclick="quickAddIngredient('Packaging error ExitCode 25')">Packaging Error</button>
          <button class="example-btn" onclick="quickAddIngredient('Lumen flickering')">Lumen</button>
          <button class="example-btn" onclick="quickAddIngredient('Blueprint Accessed None')">Blueprint</button>
          <button class="example-btn" onclick="quickAddIngredient('GPU crash D3D')">GPU Crash</button>
        </div>
      </section>

      <!-- Popular Paths Gallery -->
      <section class="gallery-section" id="gallerySection">
        <h2 style="color: var(--text); margin-bottom: 1rem; font-size: 1.25rem">
          üìö Popular Learning Paths
        </h2>
        <p
          style="
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
          "
        >
          Click any card to load a pre-built path instantly
        </p>
        <div class="gallery-grid" id="galleryGrid">
          <!-- Gallery cards will be populated by JS -->
        </div>
      </section>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">ü§ñ AI is curating your path...</p>
        <p class="loading-subtext">
          Finding the best content and timestamps for you
        </p>
      </div>

      <section class="path-section" id="pathSection">
        <div class="path-header">
          <button class="back-btn" onclick="goBackToSearch()">
            ‚Üê Back to Search
          </button>
          <h2 class="path-title" id="pathTitle">üéØ Your Learning Path</h2>
          <p class="path-query" id="pathQuery"></p>
          <div
            style="
              background: rgba(14, 165, 233, 0.1);
              border-left: 4px solid var(--primary);
              padding: 1rem;
              border-radius: 0.5rem;
              margin: 1rem 0;
            "
          >
            <strong>üí° How to use this path:</strong>
            <ol style="margin: 0.5rem 0 0 1.25rem; color: var(--text-muted)">
              <li>Work through each step in order</li>
              <li>Watch the most relevant video in each step</li>
              <li>Mark steps complete as you go</li>
            </ol>
          </div>
          <div class="path-tags" id="pathTags"></div>
        </div>

        <div class="steps-container" id="stepsContainer">
          <!-- Steps will be inserted here -->
        </div>

        <div class="progress-section">
          <span class="progress-text" id="progressText"
            >Progress: 0/4 steps</span
          >
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <button
            class="complete-btn"
            onclick="sharePath()"
            style="background: var(--primary)"
          >
            Share Path üîó
          </button>
        </div>
      </section>

      <footer class="site-footer">
        <div class="footer-content">
          <div class="footer-main">
            <p>Powered by <strong>UE5 Learning Path Tagging System</strong></p>
            <p class="footer-sub">
              Content curated from YouTube, Epic Docs, and Community
            </p>
          </div>
          <div class="footer-meta">
            <span class="build-info" id="buildInfo">v0.1.86</span>
            <span class="env-badge" id="envBadge">LOCAL</span>
          </div>
        </div>
        <div class="footer-links">
          <a
            href="https://github.com/SamDeiter/Unreal-Learning-Path-Tagging-System"
            target="_blank"
            >GitHub</a
          >
          <span>‚Ä¢</span>
          <a href="https://dev.epicgames.com/documentation" target="_blank"
            >Epic Docs</a
          >
        </div>
      </footer>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal" onclick="closeVideo(event)">
      <div class="video-container" onclick="event.stopPropagation()">
        <button class="video-close" onclick="closeVideo()">&times;</button>
        <iframe id="videoFrame" src="" allowfullscreen></iframe>
      </div>
    </div>

    <script>
      // Sample learning path data (would come from backend API)
      const samplePaths = {
        packaging: {
          title: "Fix UE5 Packaging Errors",
          query: "UE5 packaging error ExitCode 25",
          tags: ["build.packaging", "build.exitcode_25", "build.cooking"],
          steps: [
            {
              number: 1,
              type: "foundations",
              title: "Understand the Build Pipeline",
              description:
                "Learn how UE5 packages and cooks content before diving into fixes.",
              content: [
                {
                  type: "video",
                  title: "UE5 Packaging Complete Guide",
                  url: "https://youtube.com/watch?v=example1",
                },
                {
                  type: "docs",
                  title: "Cooking Content - Epic Docs",
                  url: "https://dev.epicgames.com/documentation",
                },
              ],
            },
            {
              number: 2,
              type: "diagnostics",
              title: "Diagnose Exit Code 25",
              description:
                "Understand what causes Unknown Cook Failure and how to read logs.",
              content: [
                {
                  type: "video",
                  title: "Reading UE5 Build Logs",
                  url: "https://youtube.com/watch?v=example2",
                },
                {
                  type: "forum",
                  title: "ExitCode 25 Common Causes",
                  url: "https://forums.unrealengine.com",
                },
              ],
            },
            {
              number: 3,
              type: "resolution",
              title: "Apply the Fix",
              description:
                "Step-by-step solutions for the most common packaging failures.",
              content: [
                {
                  type: "video",
                  title: "Fix ExitCode 25 - Complete Solution",
                  url: "https://youtube.com/watch?v=example3",
                },
                {
                  type: "video",
                  title: "Asset Naming Conventions",
                  url: "https://youtube.com/watch?v=example4",
                },
              ],
            },
            {
              number: 4,
              type: "prevention",
              title: "Prevent Future Issues",
              description:
                "Best practices to avoid packaging errors in your projects.",
              content: [
                {
                  type: "video",
                  title: "UE5 Project Organization Tips",
                  url: "https://youtube.com/watch?v=example5",
                },
                {
                  type: "docs",
                  title: "Asset Management Best Practices",
                  url: "https://dev.epicgames.com/documentation",
                },
              ],
            },
          ],
        },
      };

      let currentPath = null;
      let completedSteps = new Set();

      // Simple markdown to HTML converter
      function parseMarkdown(text) {
        if (!text) return "";
        return text
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // **bold**
          .replace(/\*(.*?)\*/g, "<em>$1</em>") // *italic*
          .replace(/\n\n/g, "<br><br>") // paragraphs
          .replace(/‚è±Ô∏è/g, "<br>‚è±Ô∏è"); // line break before timestamp
      }

      // Extract video ID from YouTube URL
      function getYouTubeId(url) {
        const match = url.match(
          /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/,
        );
        return match ? match[1] : null;
      }

      // Play video in modal
      function playVideo(url, description) {
        const videoId = getYouTubeId(url);
        if (!videoId) {
          window.open(url, "_blank");
          return;
        }

        // Try to extract START timestamp from description
        let startTime = 0;
        if (description) {
          // Check for explicit "beginning" or "0:00"
          if (/start\s*(?:at\s*)?(?:the\s*)?beginning/i.test(description)) {
            startTime = 0;
          }
          // Look for explicit "Start at X:XX" or "from X:XX"
          else {
            const startMatch = description.match(
              /(?:start|from)\s*(?:at\s*)?(\d{1,2}):(\d{2})/i,
            );
            if (startMatch) {
              startTime =
                parseInt(startMatch[1]) * 60 + parseInt(startMatch[2]);
            }
            // Fallback: look for any X:XX pattern
            else {
              const anyTimeMatch = description.match(/(\d{1,2}):(\d{2})/);
              if (anyTimeMatch) {
                startTime =
                  parseInt(anyTimeMatch[1]) * 60 + parseInt(anyTimeMatch[2]);
              }
            }
          }
        }

        const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&start=${startTime}`;
        document.getElementById("videoFrame").src = embedUrl;
        document.getElementById("videoModal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      // Helper to play video from content card (uses data attributes)
      function playVideoFromCard(card) {
        const url = card.dataset.url;
        const desc = card.dataset.desc
          ? decodeURIComponent(card.dataset.desc)
          : "";
        playVideo(url, desc);
      }

      // Close video modal
      function closeVideo(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById("videoFrame").src = "";
        document.getElementById("videoModal").classList.remove("active");
        document.body.style.overflow = "";
      }

      // Close on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeVideo();
      });

      function setQuery(query) {
        document.getElementById("queryInput").value = query;
      }

      // Toggle crash log textarea visibility
      function toggleCrashLog() {
        const container = document.getElementById("crashlogContainer");
        const isVisible = container.style.display !== "none";
        container.style.display = isVisible ? "none" : "block";
        if (!isVisible) {
          document.getElementById("crashLogInput").focus();
        }
      }

      // UE5 Error Patterns for parsing crash logs
      const UE5_ERROR_PATTERNS = [
        {
          pattern: /ExitCode[=:\s]*(\d+)/i,
          type: "exitcode",
          extract: (m) => `ExitCode ${m[1]}`,
        },
        {
          pattern: /Error[:\s]+([A-Z]+\d+)/i,
          type: "linker",
          extract: (m) => m[1],
        },
        {
          pattern: /ShaderCompileWorker/i,
          type: "shader",
          extract: () => "Shader compilation error",
        },
        {
          pattern: /D3D\s*device\s*lost/i,
          type: "gpu",
          extract: () => "D3D device lost",
        },
        { pattern: /GPU\s*crash/i, type: "gpu", extract: () => "GPU crash" },
        {
          pattern: /Accessed\s*None/i,
          type: "blueprint",
          extract: () => "Blueprint Accessed None",
        },
        {
          pattern: /cook\s*(fail|error)/i,
          type: "cook",
          extract: () => "Cook failure",
        },
        {
          pattern: /packaging\s*(fail|error)/i,
          type: "packaging",
          extract: () => "Packaging error",
        },
        { pattern: /Lumen/i, type: "lumen", extract: () => "Lumen issue" },
        { pattern: /Nanite/i, type: "nanite", extract: () => "Nanite issue" },
        {
          pattern: /replication|multiplayer|net/i,
          type: "network",
          extract: () => "Network/replication",
        },
        {
          pattern: /Fatal\s*error/i,
          type: "fatal",
          extract: () => "Fatal error",
        },
        {
          pattern: /LogCore:\s*Error/i,
          type: "core",
          extract: () => "Core error",
        },
        {
          pattern: /out\s*of\s*(memory|video\s*memory)/i,
          type: "memory",
          extract: () => "Out of memory",
        },
      ];

      // Parse crash log and extract key terms
      function parseCrashLog() {
        const logInput = document.getElementById("crashLogInput").value.trim();
        if (!logInput) {
          alert("Please paste a crash log or error output first.");
          return;
        }

        const extractedTerms = [];
        const seenTypes = new Set();

        // Run all patterns
        for (const { pattern, type, extract } of UE5_ERROR_PATTERNS) {
          const match = logInput.match(pattern);
          if (match && !seenTypes.has(type)) {
            extractedTerms.push(extract(match));
            seenTypes.add(type);
          }
        }

        // Display extracted tags
        const tagsContainer = document.getElementById("extractedTags");
        if (extractedTerms.length > 0) {
          tagsContainer.innerHTML = extractedTerms
            .map((t) => `<span class="extracted-tag">${t}</span>`)
            .join("");

          // Build query from extracted terms
          const query = extractedTerms.slice(0, 3).join(" ");
          document.getElementById("queryInput").value = query;

          // Auto-generate the path
          generatePath();
        } else {
          tagsContainer.innerHTML =
            '<span class="extracted-tag" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.3);">No patterns found - try describing the issue</span>';
        }
      }

      // =====================================================
      // PROBLEM BASKET - Ingredient Management
      // =====================================================
      const ingredients = [];
      let currentPanel = null;
      let currentScreenshot = null;

      function showInputPanel(panelType) {
        const panels = ['text', 'log', 'screenshot'];
        const buttons = document.querySelectorAll('.input-method-btn');
        panels.forEach((p, i) => {
          const panel = document.getElementById(p + 'Panel');
          const btn = buttons[i];
          if (p === panelType && currentPanel !== panelType) {
            panel.style.display = 'flex';
            btn.classList.add('active');
          } else {
            panel.style.display = 'none';
            btn.classList.remove('active');
          }
        });
        currentPanel = currentPanel === panelType ? null : panelType;
        if (currentPanel === 'text') document.getElementById('textInput').focus();
        else if (currentPanel === 'log') document.getElementById('logInput').focus();
      }

      function addTextIngredient() {
        const input = document.getElementById('textInput');
        const text = input.value.trim();
        if (!text) return;
        addIngredient('text', text, 'üìù');
        input.value = '';
      }

      const UE5_PATTERNS = [
        { pattern: /ExitCode[=:\s]*(\d+)/i, extract: m => `ExitCode ${m[1]}` },
        { pattern: /ShaderCompileWorker/i, extract: () => "Shader error" },
        { pattern: /D3D\s*device\s*lost/i, extract: () => "D3D device lost" },
        { pattern: /Accessed\s*None/i, extract: () => "Accessed None" },
        { pattern: /Lumen/i, extract: () => "Lumen" },
        { pattern: /Nanite/i, extract: () => "Nanite" },
        { pattern: /packaging\s*(fail|error)/i, extract: () => "Packaging error" },
        { pattern: /Fatal\s*error/i, extract: () => "Fatal error" },
      ];

      function addLogIngredient() {
        const textarea = document.getElementById('logInput');
        const log = textarea.value.trim();
        if (!log) return;
        const found = new Set();
        for (const { pattern, extract } of UE5_PATTERNS) {
          const match = log.match(pattern);
          if (match) found.add(extract(match));
        }
        if (found.size > 0) found.forEach(term => addIngredient('log', term, 'üìã'));
        else addIngredient('log', log.split('\n')[0].substring(0, 40), 'üìã');
        textarea.value = '';
      }

      function handleScreenshotSelect(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          currentScreenshot = { data: e.target.result, name: file.name };
          document.getElementById('dropzoneContent').style.display = 'none';
          document.getElementById('screenshotPreview').style.display = 'block';
          document.getElementById('previewImage').src = currentScreenshot.data;
          document.getElementById('addScreenshotBtn').disabled = false;
        };
        reader.readAsDataURL(file);
      }

      function clearScreenshotPreview() {
        currentScreenshot = null;
        document.getElementById('screenshotInput').value = '';
        document.getElementById('dropzoneContent').style.display = 'flex';
        document.getElementById('screenshotPreview').style.display = 'none';
        document.getElementById('addScreenshotBtn').disabled = true;
      }

      function addScreenshotIngredient() {
        if (!currentScreenshot) return;
        addIngredient('screenshot', 'Screenshot', 'üì∑', currentScreenshot.data);
        clearScreenshotPreview();
      }

      function addIngredient(type, label, icon, data = null) {
        const id = Date.now() + Math.random();
        ingredients.push({ id, type, label, icon, data });
        renderBasket();
      }

      function removeIngredient(id) {
        const idx = ingredients.findIndex(i => i.id === id);
        if (idx !== -1) { ingredients.splice(idx, 1); renderBasket(); }
      }

      function quickAddIngredient(text) { addIngredient('text', text, 'üìù'); }

      function renderBasket() {
        const empty = document.getElementById('basketEmpty');
        const chips = document.getElementById('ingredientChips');
        const btn = document.getElementById('generateBtn');
        if (ingredients.length === 0) {
          empty.style.display = 'block';
          chips.innerHTML = '';
          btn.disabled = true;
        } else {
          empty.style.display = 'none';
          chips.innerHTML = ingredients.map(ing => 
            `<div class="ingredient-chip ${ing.type}-chip"><span>${ing.icon} ${ing.label}</span><button class="chip-remove" onclick="removeIngredient(${ing.id})">‚úï</button></div>`
          ).join('');
          btn.disabled = false;
        }
      }

      function generateFromBasket() {
        if (ingredients.length === 0) return;
        const query = ingredients.filter(i => i.type !== 'screenshot').map(i => i.label).join(' ');
        document.getElementById('queryInput').value = query;
        generatePath();
      }

      // Drag and drop for screenshots
      document.addEventListener('DOMContentLoaded', () => {
        const dz = document.getElementById('screenshotDropzone');
        if (dz) {
          dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
          dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
          dz.addEventListener('drop', e => {
            e.preventDefault();
            dz.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleScreenshotSelect({ target: { files: [file] } });
          });
        }
      });


      let cachedPathsIndex = [];

      // Load the paths index on page load
      fetch("/paths/index.json")
        .then((r) => r.json())
        .then((data) => {
          cachedPathsIndex = data;
          populateGallery();
        })
        .catch(() => console.log("No cached paths index"));

      // Find best matching cached path
      function findCachedPath(query) {
        const q = query.toLowerCase();
        // First try exact match
        let match = cachedPathsIndex.find((p) => p.query.toLowerCase() === q);
        if (match) return match;
        // Then try partial match (query contains cached query term)
        match = cachedPathsIndex.find((p) => q.includes(p.query.toLowerCase()));
        if (match) return match;
        // Try if cached query contains search term
        match = cachedPathsIndex.find((p) =>
          p.query.toLowerCase().includes(q.split(" ")[0]),
        );
        return match;
      }

      // Populate the gallery with cached paths
      function populateGallery() {
        const grid = document.getElementById("galleryGrid");
        if (!grid) return;

        grid.innerHTML = ""; // Clear existing cards

        // Icon mapping based on query keywords
        const getIcon = (query) => {
          const q = query.toLowerCase();
          if (q.includes("lumen")) return "üí°";
          if (q.includes("nanite")) return "üî∑";
          if (q.includes("blueprint")) return "üìò";
          if (q.includes("crash") || q.includes("gpu") || q.includes("d3d"))
            return "üí•";
          if (q.includes("packaging") || q.includes("cook")) return "üì¶";
          if (q.includes("exit")) return "‚ö†Ô∏è";
          return "üéØ";
        };

        cachedPathsIndex.forEach((path, index) => {
          const card = document.createElement("button");
          card.className = "gallery-card";
          card.onclick = () => loadGalleryPath(path.file);

          const popularBadge =
            index < 3 ? '<span class="popular-badge">üî• Popular</span>' : "";

          card.innerHTML = `
            <span class="gallery-icon">${getIcon(path.query)}</span>
            <span class="gallery-title">${path.query}</span>
            <span class="gallery-steps">${path.steps} steps</span>
            ${popularBadge}
          `;

          grid.appendChild(card);
        });

        // Show gallery section
        document.getElementById("gallerySection").style.display = "block";
      }

      // Load a path from the gallery
      function loadGalleryPath(filename) {
        document.getElementById("loading").classList.add("active");
        document.getElementById("gallerySection").style.display = "none";

        fetch(`/paths/${filename}`)
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("loading").classList.remove("active");
            currentPath = data;
            renderPath(currentPath);
            if (typeof Tracker !== "undefined") {
              Tracker.trackEvent("path_started", {
                pathId: data.path_id,
                title: data.title,
              });
            }
          })
          .catch((err) => {
            document.getElementById("loading").classList.remove("active");
            alert("Failed to load path: " + err.message);
          });
      }

      function generatePath() {
        const query = document.getElementById("queryInput").value.trim();
        if (!query) return;

        // Show loading
        document.getElementById("loading").classList.add("active");
        document.getElementById("pathSection").classList.remove("active");
        document.getElementById("gallerySection").style.display = "none";

        // Try to find matching cached path
        const cached = findCachedPath(query);

        if (cached) {
          fetch(`/paths/${cached.file}`)
            .then((response) => {
              if (!response.ok) throw new Error("Cache miss");
              return response.json();
            })
            .then((data) => {
              document.getElementById("loading").classList.remove("active");
              currentPath = data;
              renderPath(currentPath);
              logQuery(query, true);
              console.log("Loaded from cache:", cached.file);
            })
            .catch(() => tryApiCall(query));
        } else {
          tryApiCall(query);
        }
      }

      function tryApiCall(query) {
        // Cache miss - try API (works only with local server)
        fetch(`/api/generate?q=${encodeURIComponent(query)}`)
          .then((response) => {
            if (!response.ok) throw new Error("API error");
            return response.json();
          })
          .then((data) => {
            document.getElementById("loading").classList.remove("active");
            currentPath = data;
            renderPath(currentPath);
            logQuery(query, data.steps && data.steps.length > 0);
          })
          .catch((error) => {
            document.getElementById("loading").classList.remove("active");
            // Log the query even if it failed (helps identify trending requests)
            logQuery(query, false);
            alert(
              "This query isn't cached yet. Try one of the common queries like:\n\n‚Ä¢ Lumen flickering\n‚Ä¢ Packaging error\n‚Ä¢ Blueprint accessed none\n\nOr run locally with: python ui/server.py",
            );
          });
      }

      function renderPath(path) {
        document.getElementById("pathTitle").textContent =
          "üéØ Your Learning Path";

        // Build query display with AI info
        let queryHtml = `<strong>Problem:</strong> "${path.query}"`;
        if (path.ai_summary) {
          queryHtml += `<br><br>üìù <strong>What's happening:</strong> ${path.ai_summary}`;
        }
        if (path.ai_estimated_time || path.ai_difficulty) {
          queryHtml += `<br><br>`;
          if (path.ai_estimated_time)
            queryHtml += `‚è±Ô∏è ${path.ai_estimated_time} `;
          if (path.ai_difficulty) queryHtml += `| üìä ${path.ai_difficulty}`;
        }
        if (path.ai_hint) {
          queryHtml += `<br><br>üí° <strong>Tip:</strong> ${path.ai_hint}`;
        }
        if (path.ai_what_you_learn && path.ai_what_you_learn.length > 0) {
          queryHtml += `<br><br><strong>What you'll learn:</strong><ul style="margin: 0.5rem 0 0 1.25rem; color: var(--text-muted);">`;
          path.ai_what_you_learn.forEach((item) => {
            queryHtml += `<li>${item}</li>`;
          });
          queryHtml += `</ul>`;
        }
        document.getElementById("pathQuery").innerHTML = queryHtml;

        // Render tags
        const tagsContainer = document.getElementById("pathTags");
        tagsContainer.innerHTML = path.tags
          .map((t) => `<span class="tag">${t}</span>`)
          .join("");

        // Render steps
        const stepsContainer = document.getElementById("stepsContainer");
        stepsContainer.innerHTML = path.steps
          .map(
            (step) => `
                <div class="step-card" id="step-${step.number}" data-type="${step.type}">
                    <div class="step-header" onclick="toggleStep(${step.number})">
                        <div class="step-number"><span>${step.number}</span></div>
                        <span class="step-type ${step.type}">${step.type}</span>
                        <span class="step-title">${step.title}</span>
                        <span class="step-toggle">‚ñº</span>
                    </div>
                    <div class="step-content">
                        <p class="step-description">${step.description.split("\n\nüëâ")[0]}</p>
                        <div class="content-list">
                            ${step.content
                              .map((c) => {
                                const safeDesc = encodeURIComponent(
                                  c.description || "",
                                );
                                return `
                                <div class="content-item" data-url="${c.url}" data-desc="${safeDesc}">
                                    ${c.thumbnail_url ? `<img src="${c.thumbnail_url}" alt="" class="content-thumbnail" onclick="playVideoFromCard(this.closest('.content-item'))">` : ""}
                                    <div class="content-details">
                                        <div class="content-type">${c.type}</div>
                                        <div class="content-title">${c.title}</div>
                                        ${c.description ? `<p class="content-description">${parseMarkdown(c.description)}</p>` : ""}
                                        <div class="content-actions">
                                            ${c.type.toLowerCase() === "video" ? `<button class="watch-btn" onclick="playVideoFromCard(this.closest('.content-item'))">‚ñ∂ Watch</button>` : ""}
                                            <a href="${c.url}" target="_blank" class="content-link">Open Resource ‚Üó</a>
                                        </div>
                                    </div>
                                </div>`;
                              })
                              .join("")}
                        </div>
                        ${
                          step.action
                            ? `
                        <div class="action-box" style="margin-top: 1rem;">
                            <span class="action-icon">üëâ</span>
                            <div>
                                <div class="action-label">Your Action</div>
                                <div class="action-text">${step.action}</div>
                            </div>
                        </div>
                        `
                            : ""
                        }
                        <button class="complete-btn" onclick="completeStep(${step.number})"
                                id="complete-${step.number}" style="margin-top: 1rem;">
                            ‚úì Mark Complete
                        </button>
                    </div>
                </div>
            `,
          )
          .join("");

        document.getElementById("pathSection").classList.add("active");
        updateProgress();
      }

      function toggleStep(num) {
        const card = document.getElementById(`step-${num}`);
        card.classList.toggle("expanded");
      }

      function completeStep(num) {
        completedSteps.add(num);
        const card = document.getElementById(`step-${num}`);
        card.classList.add("completed");
        const btn = document.getElementById(`complete-${num}`);
        btn.textContent = "‚úì Completed";
        btn.disabled = true;
        btn.style.background = "var(--success)";
        btn.style.opacity = "0.8";
        updateProgress();
      }

      function updateProgress() {
        if (!currentPath) return;
        const total = currentPath.steps.length;
        const completed = completedSteps.size;
        const percent = (completed / total) * 100;

        document.getElementById("progressText").textContent =
          `Progress: ${completed}/${total} steps`;
        document.getElementById("progressFill").style.width = percent + "%";
      }

      function sharePath() {
        const pathId = currentPath?.path_id || "";
        const query = currentPath?.query || "";

        // Use path_id for exact path sharing, fallback to query
        const shareUrl = pathId
          ? `${window.location.origin}${window.location.pathname}?pathId=${encodeURIComponent(pathId)}`
          : `${window.location.origin}${window.location.pathname}?q=${encodeURIComponent(query)}`;

        navigator.clipboard
          .writeText(shareUrl)
          .then(() => {
            alert(
              "Link copied to clipboard! üîó\n\nShare this URL with others:\n" +
                shareUrl,
            );
          })
          .catch(() => {
            prompt("Copy this URL to share:", shareUrl);
          });
      }

      function goBackToSearch() {
        // Clear URL params
        window.history.pushState({}, "", window.location.pathname);

        // Hide path section
        document.getElementById("pathSection").classList.remove("active");

        // Show gallery
        document.getElementById("gallerySection").style.display = "block";

        // Clear search input
        document.getElementById("queryInput").value = "";

        // Track navigation if available
        if (typeof Tracker !== "undefined") {
          Tracker.trackEvent("navigation", { action: "back_to_search" });
        }
      }

      // Enter key support
      document
        .getElementById("queryInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") generatePath();
        });
    </script>
  </body>
</html>
