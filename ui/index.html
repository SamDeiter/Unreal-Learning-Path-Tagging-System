<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UE5 Learning Path Builder</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- xAPI (Tin Can) Support for LMS Integration -->
    <script src="js/xapiwrapper.min.js"></script>
    <script src="js/tracking.js"></script>
    <script>
      // Firebase configuration for ue5-learning-paths project
      const firebaseConfig = {
        apiKey: "REDACTED_FIREBASE_API_KEY",
        authDomain: "ue5-learning-paths.firebaseapp.com",
        projectId: "ue5-learning-paths",
        storageBucket: "ue5-learning-paths.firebasestorage.app",
        messagingSenderId: "687715963885",
        appId: "1:687715963885:web:d34c7a26f7471ff0d54de4",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Rate limiting - max 10 queries per 5 minutes
      const queryHistory = [];
      const RATE_LIMIT = 10;
      const RATE_WINDOW_MS = 5 * 60 * 1000; // 5 minutes

      function isRateLimited() {
        const now = Date.now();
        // Remove old entries
        while (
          queryHistory.length > 0 &&
          queryHistory[0] < now - RATE_WINDOW_MS
        ) {
          queryHistory.shift();
        }
        return queryHistory.length >= RATE_LIMIT;
      }

      // Sanitize input - only allow safe characters
      function sanitizeQuery(query) {
        return query
          .substring(0, 200) // Max length
          .replace(/[<>{}()\[\]\\\/'"`;]/g, "") // Remove dangerous chars
          .trim();
      }

      // Log a query to Firestore for trend tracking
      async function logQuery(query, hasResults) {
        if (isRateLimited()) {
          console.log("Rate limited - skipping log");
          return;
        }

        queryHistory.push(Date.now());
        const sanitized = sanitizeQuery(query);
        if (!sanitized) return;

        try {
          await db.collection("query_logs").add({
            query: sanitized.toLowerCase(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            hasResults: hasResults,
          });
        } catch (e) {
          console.log("Query logging disabled or failed:", e.message);
        }

        // Also track via unified Tracker (works in both standalone and LMS modes)
        if (typeof Tracker !== "undefined") {
          Tracker.trackQuery(sanitized, []);
        }
      }
    </script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/search.css" />
    <link rel="stylesheet" href="css/learning-path.css" />
    <link rel="stylesheet" href="css/layout.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ® UE5 Learning Path Builder</h1>
        <p class="subtitle">
          Enter your problem, get a structured learning path from existing
          content
        </p>
      </header>

      <section class="search-section">
        <h2 class="basket-title">ğŸ§º Build Your Problem</h2>
        <p class="basket-subtitle">
          Add ingredients to describe your issue, then generate a learning path
        </p>

        <!-- Hidden queryInput for compatibility -->
        <input type="hidden" id="queryInput" value="" />

        <!-- Input Method Buttons -->
        <div class="input-methods">
          <button
            class="input-method-btn text-btn"
            onclick="showInputPanel('text')"
          >
            <span class="method-icon">ğŸ“</span>
            <span class="method-label">Describe Issue</span>
          </button>
          <button
            class="input-method-btn log-btn"
            onclick="showInputPanel('log')"
          >
            <span class="method-icon">ğŸ“‹</span>
            <span class="method-label">Paste Error Log</span>
          </button>
          <button
            class="input-method-btn screenshot-btn"
            onclick="showInputPanel('screenshot')"
          >
            <span class="method-icon">ğŸ“·</span>
            <span class="method-label">Add Screenshot</span>
          </button>
          <button
            class="input-method-btn tags-btn"
            onclick="showInputPanel('tags')"
          >
            <span class="method-icon">ğŸ·ï¸</span>
            <span class="method-label">Browse Tags</span>
          </button>
        </div>

        <!-- Expandable Input Panels -->
        <div class="input-panels">
          <div class="input-panel" id="textPanel" style="display: none">
            <input
              type="text"
              class="basket-input"
              id="textInput"
              placeholder="Describe your UE5 problem..."
            />
            <button class="add-ingredient-btn" onclick="addTextIngredient()">
              + Add
            </button>
          </div>
          <div class="input-panel" id="logPanel" style="display: none">
            <textarea
              id="logInput"
              class="basket-textarea"
              placeholder="Paste crash log or error output..."
              rows="4"
            ></textarea>
            <button
              class="add-ingredient-btn log-add"
              onclick="addLogIngredient()"
            >
              + Extract & Add
            </button>
          </div>
          <div class="input-panel" id="screenshotPanel" style="display: none">
            <div
              class="screenshot-dropzone"
              id="screenshotDropzone"
              onclick="document.getElementById('screenshotInput').click()"
            >
              <input
                type="file"
                id="screenshotInput"
                accept="image/*"
                style="display: none"
                onchange="handleScreenshotSelect(event)"
              />
              <div class="dropzone-content" id="dropzoneContent">
                <span class="dropzone-icon">ğŸ“</span>
                <span class="dropzone-text">Click or drag to upload</span>
              </div>
              <div
                class="screenshot-preview"
                id="screenshotPreview"
                style="display: none"
              >
                <img id="previewImage" alt="Preview" />
                <button
                  class="remove-preview"
                  onclick="
                    event.stopPropagation();
                    clearScreenshotPreview();
                  "
                >
                  âœ•
                </button>
              </div>
            </div>
            <button
              class="add-ingredient-btn screenshot-add"
              id="addScreenshotBtn"
              onclick="addScreenshotIngredient()"
              disabled
            >
              + Add Screenshot
            </button>
          </div>
          <!-- Tags Panel (dynamic suggestions based on basket) -->
          <div class="input-panel" id="tagsPanel" style="display: none">
            <div class="tag-cloud" id="tagCloud">
              <span style="color: var(--text-muted)"
                >Loading suggestions...</span
              >
            </div>
          </div>
        </div>

        <!-- Ingredient Basket -->
        <div class="ingredient-basket" id="ingredientBasket">
          <div class="basket-empty" id="basketEmpty">
            <span>No ingredients yet â€” add something above!</span>
          </div>
          <div class="ingredient-chips" id="ingredientChips"></div>
        </div>

        <!-- Generate Button -->
        <button
          class="generate-btn"
          id="generateBtn"
          onclick="generateFromBasket()"
          disabled
        >
          ğŸš€ Generate Learning Path
        </button>
      </section>

      <!-- Popular Paths Gallery -->
      <section class="gallery-section" id="gallerySection">
        <h2 style="color: var(--text); margin-bottom: 1rem; font-size: 1.25rem">
          ğŸ“š Popular Learning Paths
        </h2>
        <p
          style="
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
          "
        >
          Click any card to load a pre-built path instantly
        </p>
        <div class="gallery-grid" id="galleryGrid">
          <!-- Gallery cards will be populated by JS -->
        </div>
      </section>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">ğŸ¤– AI is curating your path...</p>
        <p class="loading-subtext">
          Finding the best content and timestamps for you
        </p>
      </div>

      <section class="path-section" id="pathSection">
        <div class="path-layout">
          <!-- Main content column -->
          <div class="path-main">
            <div class="path-header">
              <button class="back-btn" onclick="goBackToSearch()">
                â† Back to Search
              </button>
              <h2 class="path-title" id="pathTitle">ğŸ¯ Your Learning Path</h2>
              <p class="path-query" id="pathQuery"></p>
              <div class="path-tags" id="pathTags"></div>
            </div>

            <div class="steps-container" id="stepsContainer">
              <!-- Steps will be inserted here -->
            </div>

            <div class="progress-section mobile-only">
              <span class="progress-text" id="progressTextMobile"
                >Progress: 0/4 steps</span
              >
              <div class="progress-bar">
                <div class="progress-fill" id="progressFillMobile"></div>
              </div>
              <button
                class="complete-btn"
                onclick="sharePath()"
                style="background: var(--primary)"
              >
                Share Path ğŸ”—
              </button>
            </div>
          </div>

          <!-- Sticky progress sidebar -->
          <aside class="progress-sidebar" id="progressSidebar">
            <div class="sidebar-header">
              <h3>ğŸ“ Progress</h3>
              <span class="progress-count" id="progressCount">0/4</span>
            </div>
            <div class="progress-bar sidebar-progress">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <nav class="step-tree" id="stepTree">
              <!-- Step tree will be populated by JS -->
            </nav>
            <div class="sidebar-actions">
              <button class="sidebar-btn" onclick="sharePath()">
                ğŸ”— Share Path
              </button>
              <button class="sidebar-btn secondary" onclick="goBackToSearch()">
                â† New Search
              </button>
            </div>
          </aside>
        </div>
      </section>

      <footer class="site-footer">
        <div class="footer-content">
          <div class="footer-main">
            <p>Powered by <strong>UE5 Learning Path Tagging System</strong></p>
            <p class="footer-sub">
              Content curated from YouTube, Epic Docs, and Community
            </p>
          </div>
          <div class="footer-meta">
            <span class="build-info" id="buildInfo">v0.1.86</span>
            <span class="env-badge" id="envBadge">LOCAL</span>
          </div>
        </div>
        <div class="footer-links">
          <a
            href="https://github.com/SamDeiter/Unreal-Learning-Path-Tagging-System"
            target="_blank"
            >GitHub</a
          >
          <span>â€¢</span>
          <a href="https://dev.epicgames.com/documentation" target="_blank"
            >Epic Docs</a
          >
        </div>
      </footer>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal" onclick="closeVideo(event)">
      <div class="video-container" onclick="event.stopPropagation()">
        <button class="video-close" onclick="closeVideo()">&times;</button>
        <iframe id="videoFrame" src="" allowfullscreen></iframe>
      </div>
    </div>

    <!-- Modular Architecture Scripts -->
    <script src="js/video.js"></script>
    <script src="js/basket.js"></script>
    <script src="js/api.js"></script>
    <script src="js/tagCloud.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
