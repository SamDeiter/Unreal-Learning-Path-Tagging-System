import{j as e,g as k}from"./index-CRsysvab.js";import{a as u}from"./vendor-cytoscape-hdah7_Xt.js";import{c as E,q as F,d as S,w as D,e as $,t as G,f as L}from"./vendor-firebase-DXZ8tGTv.js";import"./data-courses-CW9cTscP.js";function n({text:c,children:p}){return e.jsxs("span",{className:"ca-tip-wrap",children:[p,e.jsx("span",{className:"ca-tip-icon",title:c,children:"‚ìò"}),e.jsx("span",{className:"ca-tip-popup",children:c})]})}function T(){const[c,p]=u.useState([]),[m,f]=u.useState(!0),[b,y]=u.useState(null),[g,h]=u.useState(100),x=u.useCallback(async()=>{f(!0),y(null);try{const a=k(),s=E(a),r=F(S(s,"apiUsage"),D("type","==","confidence_routing"),$("timestamp","desc"),G(g)),R=(await L(r)).docs.map(v=>({id:v.id,...v.data(),timestamp:v.data().timestamp?.toDate?.()||null}));p(R)}catch(a){console.error("Failed to load confidence analytics:",a),y(a.message)}finally{f(!1)}},[g]);u.useEffect(()=>{x()},[x]);const l=c.length,t=c.filter(a=>a.outcome==="clarify").length,d=c.filter(a=>a.outcome==="direct_answer").length,i=c.filter(a=>a.outcome==="agentic_rag").length,w=l>0?(c.reduce((a,s)=>a+(s.score||0),0)/l).toFixed(1):"‚Äî",A=l>0?Math.round(c.reduce((a,s)=>a+(s.queryLength||0),0)/l):"‚Äî",o=a=>l>0?(a/l*100).toFixed(1):"0",N={};c.forEach(a=>{(a.reasons||[]).forEach(s=>{N[s]=(N[s]||0)+1})});const j=Object.entries(N).sort((a,s)=>s[1]-a[1]).slice(0,8);return e.jsxs("div",{className:"ca-container",children:[e.jsxs("div",{className:"ca-header",children:[e.jsxs("h3",{children:["üß† Confidence Routing Analytics",e.jsx("span",{className:"ca-header-subtitle",children:"How the AI decides whether to clarify or answer directly"})]}),e.jsxs("div",{className:"ca-controls",children:[e.jsxs("select",{value:g,onChange:a=>h(Number(a.target.value)),className:"ca-limit-select",children:[e.jsx("option",{value:50,children:"Last 50"}),e.jsx("option",{value:100,children:"Last 100"}),e.jsx("option",{value:250,children:"Last 250"}),e.jsx("option",{value:500,children:"Last 500"})]}),e.jsx("button",{className:"ca-refresh-btn",onClick:x,disabled:m,children:"üîÑ Refresh"})]})]}),b&&e.jsxs("div",{className:"ca-error",children:["‚ö†Ô∏è ",b]}),m?e.jsx("div",{className:"ca-loading",children:"Loading analytics‚Ä¶"}):l===0?e.jsx("div",{className:"ca-empty",children:'No confidence routing data yet. Submit a query on the "Fix a Problem" tab to start collecting analytics.'}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ca-cards ca-cards-top",children:[e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Total number of diagnostic queries processed by the AI system in this time period.",children:e.jsx("span",{className:"ca-card-value",children:l})}),e.jsx("span",{className:"ca-card-label",children:"Total Queries"})]}),e.jsxs("div",{className:"ca-card ca-card-clarify",children:[e.jsx(n,{text:"Percentage of queries where the AI asked a follow-up clarification question before answering. Higher means users are asking vague questions.",children:e.jsxs("span",{className:"ca-card-value",children:[o(t),"%"]})}),e.jsxs("span",{className:"ca-card-label",children:["Clarified (",t,")"]})]}),e.jsxs("div",{className:"ca-card ca-card-direct",children:[e.jsx(n,{text:"Percentage of queries where the AI had enough context to answer directly without asking follow-up questions. Higher is better ‚Äî means users are providing clear, detailed queries.",children:e.jsxs("span",{className:"ca-card-value",children:[o(d),"%"]})}),e.jsxs("span",{className:"ca-card-label",children:["Direct (",d,")"]})]})]}),e.jsxs("div",{className:"ca-cards ca-cards-bottom",children:[e.jsxs("div",{className:"ca-card ca-card-agentic",children:[e.jsx(n,{text:"Percentage of queries routed to the Agentic RAG pipeline ‚Äî an advanced multi-step search that automatically expands and retries when initial results are insufficient.",children:e.jsxs("span",{className:"ca-card-value",children:[o(i),"%"]})}),e.jsxs("span",{className:"ca-card-label",children:["Agentic RAG (",i,")"]})]}),e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Average confidence score across all queries (0‚Äì100+). Score determines routing: <50 = Clarify, 50‚Äì74 = Agentic RAG, 75+ = Direct Answer. Factors: query specificity, error strings, RAG passage quality, engine version, multi-turn history.",children:e.jsx("span",{className:"ca-card-value",children:w})}),e.jsx("span",{className:"ca-card-label",children:"Avg Score"})]}),e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Average character length of user queries. Longer queries tend to get higher confidence scores and better answers. Short queries (<30 chars) receive a -15 point penalty.",children:e.jsx("span",{className:"ca-card-value",children:A})}),e.jsx("span",{className:"ca-card-label",children:"Avg Query Length"})]})]}),e.jsxs("div",{className:"ca-distribution",children:[e.jsx("h4",{children:e.jsx(n,{text:"Visual breakdown of how queries were routed. Clarify (amber) = asked follow-up questions. Direct (green) = answered immediately. Agentic (purple) = used advanced multi-step search pipeline.",children:"Outcome Distribution"})}),e.jsxs("div",{className:"ca-bar",children:[t>0&&e.jsxs("div",{className:"ca-bar-segment ca-seg-clarify",style:{width:`${o(t)}%`},title:`Clarify: ${t} queries (${o(t)}%)`,children:[o(t),"%"]}),d>0&&e.jsxs("div",{className:"ca-bar-segment ca-seg-direct",style:{width:`${o(d)}%`},title:`Direct Answer: ${d} queries (${o(d)}%)`,children:[o(d),"%"]}),i>0&&e.jsxs("div",{className:"ca-bar-segment ca-seg-agentic",style:{width:`${o(i)}%`},title:`Agentic RAG: ${i} queries (${o(i)}%)`,children:[o(i),"%"]})]}),e.jsxs("div",{className:"ca-legend",children:[e.jsxs("span",{className:"ca-legend-item",children:[e.jsx("span",{className:"ca-dot ca-dot-clarify"})," Clarify"]}),e.jsxs("span",{className:"ca-legend-item",children:[e.jsx("span",{className:"ca-dot ca-dot-direct"})," Direct Answer"]}),e.jsxs("span",{className:"ca-legend-item",children:[e.jsx("span",{className:"ca-dot ca-dot-agentic"})," Agentic RAG"]})]})]}),j.length>0&&e.jsxs("div",{className:"ca-reasons",children:[e.jsx("h4",{children:e.jsx(n,{text:"Most frequent signals that influenced the confidence score. Each query can have multiple reasons. These help you understand WHY the AI chose to clarify vs answer directly.",children:"Top Scoring Reasons"})}),e.jsx("div",{className:"ca-reason-tags",children:j.map(([a,s])=>e.jsxs("span",{className:"ca-reason-tag",title:C(a),children:[a.replace(/_/g," ")," ",e.jsxs("strong",{children:["(",s,")"]})]},a))})]}),e.jsxs("details",{className:"ca-table-wrap ca-collapsible",children:[e.jsxs("summary",{className:"ca-collapsible-header",children:[e.jsx(n,{text:"Individual routing decisions in reverse chronological order. Each row shows one user query: when it happened, how it was routed, the confidence score, query length, which clarification round it was, and what signals influenced the decision.",children:"Recent Routing Decisions"}),e.jsxs("span",{className:"ca-entry-count",children:["(",c.length," entries)"]})]}),e.jsxs("table",{className:"ca-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{title:"When the query was submitted",children:"Time"}),e.jsx("th",{title:"How the AI routed this query: Clarify (asked follow-up), Direct (answered immediately), or Agentic (multi-step search)",children:"Outcome"}),e.jsx("th",{title:"Confidence score (0‚Äì100+). Higher = more confident. Thresholds: <50 Clarify, 50‚Äì74 Agentic, 75+ Direct",children:"Score"}),e.jsx("th",{title:"Character length of the user's query. Longer queries provide more context for better answers",children:"Query Len"}),e.jsx("th",{title:"Which clarification round this was. Round 0 = first query, Round 1+ = after follow-up questions",children:"Round"}),e.jsx("th",{title:"Signals that influenced the confidence score for this specific query",children:"Reasons"})]})}),e.jsx("tbody",{children:c.slice(0,25).map(a=>e.jsxs("tr",{className:`ca-row-${a.outcome}`,children:[e.jsx("td",{className:"ca-time",children:a.timestamp?a.timestamp.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"‚Äî"}),e.jsx("td",{children:e.jsx("span",{className:`ca-outcome-badge ca-badge-${a.outcome}`,children:a.outcome==="clarify"?"üîç Clarify":a.outcome==="direct_answer"?"‚úÖ Direct":"ü§ñ Agentic"})}),e.jsx("td",{className:"ca-score",children:a.score??"‚Äî"}),e.jsx("td",{children:a.queryLength??"‚Äî"}),e.jsx("td",{children:a.round??a.clarifyRoundsCompleted??"‚Äî"}),e.jsx("td",{className:"ca-reasons-cell",children:(a.reasons||[]).map((s,r)=>e.jsx("span",{className:"ca-mini-tag",title:C(s),children:s.replace(/_/g," ")},r))})]},a.id))})]})]})]})]})}function C(c){const p={multiple_systems_identified:"The AI detected 2+ UE5 subsystems in the query (e.g., Lumen + Nanite). +30 points ‚Äî highly specific.",single_system_identified:"The AI detected exactly 1 UE5 subsystem. +15 points.",engine_version_provided:"The user specified their UE5 version (e.g., 5.3). +15 points ‚Äî helps target version-specific answers.",error_strings_provided:"The user included error messages or log output. +25 points ‚Äî very specific, high confidence.",platform_provided:"The user specified their platform (Windows, Mac, etc.). +5 points.",change_context_provided:"The user described what they changed recently. +10 points ‚Äî helps narrow root cause.",strong_rag_matches:"2+ high-quality transcript passages matched (>0.4 similarity). +25 points.",partial_rag_match:"1 high-quality transcript passage matched. +15 points.",decent_rag_matches:"2+ moderate transcript passages matched (0.35‚Äì0.40 similarity). +10 points.",short_query_penalty:"Query was under 30 characters. -15 points ‚Äî too vague for a direct answer.",no_structured_context_penalty:"No case report or multi-system info provided. -10 points."};if(c.startsWith("multi_turn_rounds_")){const m=c.split("_").pop();return`${m} clarification round(s) completed. +${Math.min(m*15,45)} points ‚Äî each round adds context.`}return p[c]||c.replace(/_/g," ")}function M(){const[c,p]=u.useState([]),[m,f]=u.useState(!0),[b,y]=u.useState(null),g=u.useCallback(async()=>{f(!0),y(null);try{const s=k(),r=E(s),_=F(S(r,"apiUsage"),D("type","==","onboarding_rag"),$("timestamp","desc"),G(200)),v=(await L(_)).docs.map(q=>({id:q.id,...q.data(),timestamp:q.data().timestamp?.toDate?.()||null}));p(v)}catch(s){console.error("Failed to load onboarding analytics:",s),y(s.message)}finally{f(!1)}},[]);u.useEffect(()=>{g()},[g]);const h=c.filter(s=>s.outcome==="rag_success"||s.outcome==="rag_fallback"),x=c.filter(s=>s.outcome==="enrichment"),l=h.length,t=h.filter(s=>s.outcome==="rag_success").length,d=h.filter(s=>s.outcome==="rag_fallback").length,i=s=>l>0?(s/l*100).toFixed(1):"0",w=t>0?(h.filter(s=>s.outcome==="rag_success").reduce((s,r)=>s+(r.modulesReturned||0),0)/t).toFixed(1):"‚Äî",A=t>0?(h.filter(s=>s.outcome==="rag_success").reduce((s,r)=>s+(r.passagesFound||0),0)/t).toFixed(1):"‚Äî",o=l>0?(h.reduce((s,r)=>s+(r.pipelineDurationMs||0),0)/l/1e3).toFixed(1):"‚Äî",N=x.length>0?(x.reduce((s,r)=>s+(r.modulesEnriched||0),0)/x.reduce((s,r)=>s+(r.modulesTotal||1),0)*100).toFixed(1):"‚Äî",j={};h.forEach(s=>{s.archetype&&s.archetype!=="unknown"&&(j[s.archetype]=(j[s.archetype]||0)+1)});const a=Object.entries(j).sort((s,r)=>r[1]-s[1]).slice(0,6);return e.jsxs("div",{className:"ca-container ca-onboarding-section",children:[e.jsxs("div",{className:"ca-header",children:[e.jsxs("h3",{children:["üéì Onboarding RAG Analytics",e.jsx("span",{className:"ca-header-subtitle",children:"How effectively the AI generates learning paths from the course library"})]}),e.jsx("div",{className:"ca-controls",children:e.jsx("button",{className:"ca-refresh-btn",onClick:g,disabled:m,children:"üîÑ Refresh"})})]}),b&&e.jsxs("div",{className:"ca-error",children:["‚ö†Ô∏è ",b]}),m?e.jsx("div",{className:"ca-loading",children:"Loading onboarding analytics‚Ä¶"}):l===0?e.jsx("div",{className:"ca-empty",children:'No onboarding RAG data yet. Complete the onboarding quiz on the "Onboarding" tab to start collecting analytics.'}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ca-cards ca-cards-top",style:{gridTemplateColumns:"repeat(4, 1fr)"},children:[e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Total onboarding paths generated through the RAG pipeline (success + fallback).",children:e.jsx("span",{className:"ca-card-value",children:l})}),e.jsx("span",{className:"ca-card-label",children:"Paths Generated"})]}),e.jsxs("div",{className:"ca-card ca-card-onb-success",children:[e.jsx(n,{text:"Percentage of onboarding attempts where the RAG pipeline successfully generated a curriculum. Higher is better.",children:e.jsxs("span",{className:"ca-card-value",children:[i(t),"%"]})}),e.jsxs("span",{className:"ca-card-label",children:["RAG Success (",t,")"]})]}),e.jsxs("div",{className:"ca-card ca-card-onb-fallback",children:[e.jsx(n,{text:"Percentage that fell back to local scoring (RAG pipeline failed or timed out).",children:e.jsxs("span",{className:"ca-card-value",children:[i(d),"%"]})}),e.jsxs("span",{className:"ca-card-label",children:["Fallback (",d,")"]})]}),e.jsxs("div",{className:"ca-card ca-card-onb-enrichment",children:[e.jsx(n,{text:"Average percentage of RAG modules that were matched to real courses with playable video. Higher means more 'Watch Course' buttons appear.",children:e.jsxs("span",{className:"ca-card-value",children:[N,"%"]})}),e.jsx("span",{className:"ca-card-label",children:"Enrichment Rate"})]})]}),e.jsxs("div",{className:"ca-cards ca-cards-bottom",children:[e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Average number of curriculum modules returned by the assembler per successful path.",children:e.jsx("span",{className:"ca-card-value",children:w})}),e.jsx("span",{className:"ca-card-label",children:"Avg Modules"})]}),e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Average number of unique transcript passages retrieved from the search step per successful path.",children:e.jsx("span",{className:"ca-card-value",children:A})}),e.jsx("span",{className:"ca-card-label",children:"Avg Passages"})]}),e.jsxs("div",{className:"ca-card",children:[e.jsx(n,{text:"Average total pipeline duration (plan ‚Üí search ‚Üí assemble) in seconds.",children:e.jsxs("span",{className:"ca-card-value",children:[o,"s"]})}),e.jsx("span",{className:"ca-card-label",children:"Avg Duration"})]})]}),e.jsxs("div",{className:"ca-distribution",children:[e.jsx("h4",{children:e.jsx(n,{text:"Visual breakdown of onboarding pipeline outcomes. Success (teal) = RAG pipeline completed. Fallback (amber) = fell back to local scoring.",children:"Outcome Distribution"})}),e.jsxs("div",{className:"ca-bar",children:[t>0&&e.jsxs("div",{className:"ca-bar-segment ca-seg-onb-success",style:{width:`${i(t)}%`},title:`RAG Success: ${t} (${i(t)}%)`,children:[i(t),"%"]}),d>0&&e.jsxs("div",{className:"ca-bar-segment ca-seg-onb-fallback",style:{width:`${i(d)}%`},title:`Fallback: ${d} (${i(d)}%)`,children:[i(d),"%"]})]}),e.jsxs("div",{className:"ca-legend",children:[e.jsxs("span",{className:"ca-legend-item",children:[e.jsx("span",{className:"ca-dot ca-dot-onb-success"})," RAG Success"]}),e.jsxs("span",{className:"ca-legend-item",children:[e.jsx("span",{className:"ca-dot ca-dot-onb-fallback"})," Fallback"]})]})]}),a.length>0&&e.jsxs("div",{className:"ca-reasons",children:[e.jsx("h4",{children:e.jsx(n,{text:"Most common user archetypes detected by the planner. This shows what kinds of learners are using the onboarding system.",children:"Top Archetypes"})}),e.jsx("div",{className:"ca-reason-tags",children:a.map(([s,r])=>e.jsxs("span",{className:"ca-reason-tag ca-archetype-tag",children:[s," ",e.jsxs("strong",{children:["(",r,")"]})]},s))})]}),e.jsxs("details",{className:"ca-table-wrap ca-collapsible",children:[e.jsxs("summary",{className:"ca-collapsible-header",children:[e.jsx(n,{text:"Recent onboarding RAG pipeline events in reverse chronological order.",children:"Recent Onboarding Events"}),e.jsxs("span",{className:"ca-entry-count",children:["(",h.length," entries)"]})]}),e.jsxs("table",{className:"ca-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Outcome"}),e.jsx("th",{children:"Archetype"}),e.jsx("th",{title:"Number of transcript passages found",children:"Passages"}),e.jsx("th",{title:"Number of curriculum modules returned",children:"Modules"}),e.jsx("th",{title:"Pipeline execution time",children:"Duration"})]})}),e.jsx("tbody",{children:h.slice(0,25).map(s=>e.jsxs("tr",{className:`ca-row-${s.outcome}`,children:[e.jsx("td",{className:"ca-time",children:s.timestamp?s.timestamp.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"‚Äî"}),e.jsx("td",{children:e.jsx("span",{className:`ca-outcome-badge ${s.outcome==="rag_success"?"ca-badge-onb-success":"ca-badge-onb-fallback"}`,children:s.outcome==="rag_success"?"‚úÖ RAG Success":"‚ö†Ô∏è Fallback"})}),e.jsx("td",{children:s.archetype||"‚Äî"}),e.jsx("td",{children:s.passagesFound??"‚Äî"}),e.jsx("td",{children:s.modulesReturned??"‚Äî"}),e.jsx("td",{children:s.pipelineDurationMs?`${(s.pipelineDurationMs/1e3).toFixed(1)}s`:"‚Äî"})]},s.id))})]})]})]})]})}function U(){return e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsx(M,{})]})}export{U as default};
