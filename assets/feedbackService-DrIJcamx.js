import{d as g,a as u}from"./logger-CCt-ETDk.js";import{c as f,j as O,h as R,p as k,d as b,f as S,q as _,e as U,t as E,v as L,x as T,y as B,z as N,r as q}from"./vendor-firebase-DXZ8tGTv.js";import{g as m}from"./index-DXAD9cvj.js";import"./vendor-cytoscape-hdah7_Xt.js";import"./data-courses-5fEGG3Qt.js";const F="feedback_v1",x=.3,z=1.3;function w(){try{const e=localStorage.getItem(F);return e?JSON.parse(e):{}}catch{return{}}}function y(e){try{localStorage.setItem(F,JSON.stringify(e))}catch{}}function V(e,a){const t=w();t[e]||(t[e]={up:0,down:0}),t[e].up+=1,t[e].down=Math.max(0,t[e].down-1),t[e].lastQuery=a,t[e].lastUpdated=new Date().toISOString(),y(t)}function W(e,a){const t=w();t[e]||(t[e]={up:0,down:0}),t[e].down+=1,t[e].up=Math.max(0,t[e].up-1),t[e].lastQuery=a,t[e].lastUpdated=new Date().toISOString(),y(t)}function A(e){const t=w()[e];return t?t.up>t.down?"up":t.down>t.up?"down":null:null}function H(e,a){const t=A(e);return t==="down"?Math.round(a*x):t==="up"?Math.round(a*z):a}function J(e,a,t=[]){const r="feedback_submissions_v1",n={id:`fb_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,type:e,description:a,fileNames:t,timestamp:new Date().toISOString()};try{const o=localStorage.getItem(r),c=o?JSON.parse(o):[];c.push(n),c.length>50&&c.splice(0,c.length-50),localStorage.setItem(r,JSON.stringify(c))}catch{}return{id:n.id,timestamp:n.timestamp}}async function K(e,a,t,r,n=""){if(!(!e||e==="anonymous"))try{const o=f(m()),c=`${a}_${t}_${Date.now()}`,s=O(o,"userFeedback",e,"videoSignals",c);await R(s,{courseCode:a,videoKey:t,signal:r,query:String(n).slice(0,200),timestamp:k()}),g(`[Feedback] ${r} signal for ${a}/${t}`)}catch(o){u("[Feedback] Failed to log signal:",o.message)}}async function X(e){const a=new Map;if(!e||e==="anonymous")return a;try{const t=f(m()),r=b(t,"userFeedback",e,"videoSignals"),n=await S(r);if(n.empty)return a;const o=new Map;for(const c of n.docs){const s=c.data(),i=s.courseCode;if(!i)continue;o.has(i)||o.set(i,{watched:0,skipped:0});const d=o.get(i);s.signal==="watched"?d.watched++:s.signal==="skipped"&&d.skipped++}for(const[c,s]of o){const i=s.watched+s.skipped;if(i<2)continue;const d=s.watched/i;a.set(c,.7+d*.5)}return g(`[Feedback] Boost map: ${a.size} courses with signals`),a}catch(t){return u("[Feedback] Failed to build boost map:",t.message),a}}async function Z(e,a,t=[],r="anonymous",n=""){const o=new Date().toISOString(),c=`fb_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;try{const s=m(),i=f(s),d=[];if(t.length>0){const $=L(s);for(const l of t.slice(0,5))try{const p=T($,`feedback/${c}/${l.name}`);await B(p,l);const D=await N(p);d.push({name:l.name,size:l.size,url:D})}catch(p){u(`[Feedback] Failed to upload ${l.name}:`,p.message)}}const M={type:e,description:String(a).slice(0,2e3),attachments:d,userId:r,userEmail:n,status:"new",timestamp:k(),createdAt:o},h=await q(b(i,"feedback"),M);return g(`[Feedback] Submitted to Firestore: ${h.id}`),{id:h.id,timestamp:o,persisted:"firestore"}}catch(s){return u("[Feedback] Firestore write failed, falling back to localStorage:",s.message),{...J(e,a,t.map(d=>d.name)),persisted:"local"}}}async function C(){try{const e=f(m()),a=b(e,"feedback"),t=_(a,U("timestamp","desc"),E(50));return(await S(t)).docs.map(n=>({id:n.id,...n.data()}))}catch(e){return u("[Feedback] Failed to fetch admin feedback:",e.message),[]}}export{H as applyFeedbackMultiplier,C as getAdminFeedbackList,X as getBoostMap,A as getFeedbackStatus,K as logVideoFeedback,W as recordDownvote,J as recordFormFeedback,V as recordUpvote,Z as submitFeedbackToFirestore};
