import{d as f,a as p}from"./logger-CDyjTpW_.js";import{c as m,j as D,h as O,p as h,d as S,f as _,v as R,x as U,y as E,z as T,r as L}from"./vendor-firebase-DXZ8tGTv.js";import{g}from"./index-CE8nu1Rp.js";import"./createLucideIcon-YhyuTmrv.js";import"./vendor-cytoscape-hdah7_Xt.js";import"./data-courses-5fEGG3Qt.js";const k="feedback_v1",N=.3,x=1.3;function b(){try{const e=localStorage.getItem(k);return e?JSON.parse(e):{}}catch{return{}}}function F(e){try{localStorage.setItem(k,JSON.stringify(e))}catch{}}function q(e,a){const t=b();t[e]||(t[e]={up:0,down:0}),t[e].up+=1,t[e].down=Math.max(0,t[e].down-1),t[e].lastQuery=a,t[e].lastUpdated=new Date().toISOString(),F(t)}function G(e,a){const t=b();t[e]||(t[e]={up:0,down:0}),t[e].down+=1,t[e].up=Math.max(0,t[e].up-1),t[e].lastQuery=a,t[e].lastUpdated=new Date().toISOString(),F(t)}function z(e){const t=b()[e];return t?t.up>t.down?"up":t.down>t.up?"down":null:null}function V(e,a){const t=z(e);return t==="down"?Math.round(a*N):t==="up"?Math.round(a*x):a}function B(e,a,t=[]){const i="feedback_submissions_v1",c={id:`fb_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,type:e,description:a,fileNames:t,timestamp:new Date().toISOString()};try{const o=localStorage.getItem(i),n=o?JSON.parse(o):[];n.push(c),n.length>50&&n.splice(0,n.length-50),localStorage.setItem(i,JSON.stringify(n))}catch{}return{id:c.id,timestamp:c.timestamp}}async function W(e,a,t,i,c=""){if(!(!e||e==="anonymous"))try{const o=m(g()),n=`${a}_${t}_${Date.now()}`,s=D(o,"userFeedback",e,"videoSignals",n);await O(s,{courseCode:a,videoKey:t,signal:i,query:String(c).slice(0,200),timestamp:h()}),f(`[Feedback] ${i} signal for ${a}/${t}`)}catch(o){p("[Feedback] Failed to log signal:",o.message)}}async function H(e){const a=new Map;if(!e||e==="anonymous")return a;try{const t=m(g()),i=S(t,"userFeedback",e,"videoSignals"),c=await _(i);if(c.empty)return a;const o=new Map;for(const n of c.docs){const s=n.data(),r=s.courseCode;if(!r)continue;o.has(r)||o.set(r,{watched:0,skipped:0});const d=o.get(r);s.signal==="watched"?d.watched++:s.signal==="skipped"&&d.skipped++}for(const[n,s]of o){const r=s.watched+s.skipped;if(r<2)continue;const d=s.watched/r;a.set(n,.7+d*.5)}return f(`[Feedback] Boost map: ${a.size} courses with signals`),a}catch(t){return p("[Feedback] Failed to build boost map:",t.message),a}}async function K(e,a,t=[],i="anonymous",c=""){const o=new Date().toISOString(),n=`fb_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;try{const s=g(),r=m(s),d=[];if(t.length>0){const M=R(s);for(const l of t.slice(0,5))try{const u=U(M,`feedback/${n}/${l.name}`);await E(u,l);const $=await T(u);d.push({name:l.name,size:l.size,url:$})}catch(u){p(`[Feedback] Failed to upload ${l.name}:`,u.message)}}const y={type:e,description:String(a).slice(0,2e3),attachments:d,userId:i,userEmail:c,status:"new",timestamp:h(),createdAt:o},w=await L(S(r,"feedback"),y);return f(`[Feedback] Submitted to Firestore: ${w.id}`),{id:w.id,timestamp:o,persisted:"firestore"}}catch(s){return p("[Feedback] Firestore write failed, falling back to localStorage:",s.message),{...B(e,a,t.map(d=>d.name)),persisted:"local"}}}export{V as applyFeedbackMultiplier,H as getBoostMap,z as getFeedbackStatus,W as logVideoFeedback,G as recordDownvote,B as recordFormFeedback,q as recordUpvote,K as submitFeedbackToFirestore};
