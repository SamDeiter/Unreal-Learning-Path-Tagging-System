rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Query logs - allow writes with rate limiting and validation
    match /query_logs/{logId} {
      // Anyone can write a query log (for analytics)
      // But with strict validation to prevent abuse
      allow create: if 
        // Must have required fields
        request.resource.data.keys().hasAll(['query', 'timestamp']) &&
        // Query must be a string, max 200 chars (prevent large payloads)
        request.resource.data.query is string &&
        request.resource.data.query.size() <= 200 &&
        // Timestamp must be server timestamp
        request.resource.data.timestamp == request.time &&
        // Limit document size (prevent abuse)
        request.resource.data.keys().size() <= 5;
      
      // No reads from client (admin only via console)
      allow read: if false;
      
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // Path ratings - allow creating feedback
    match /path_ratings/{ratingId} {
      allow create: if 
        request.resource.data.keys().hasAll(['path_id', 'rating', 'timestamp']) &&
        request.resource.data.rating in ['up', 'down'] &&
        request.resource.data.timestamp == request.time &&
        request.resource.data.keys().size() <= 5;
      allow read, update, delete: if false;
    }
    
    // Cached paths - read only (managed by admin)
    match /cached_paths/{pathId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Helper: check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email in ['samdeiter@gmail.com'];
    }
    
    // Invite codes — admin creates/lists/revokes, users read + consume
    match /path_builder_invites/{code} {
      // Admin can do anything
      allow read, write: if isAdmin();
      // Authenticated users can read individual invites (to validate)
      allow get: if request.auth != null;
      // Authenticated users can update usedCount when consuming
      allow update: if request.auth != null
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount', 'lastUsedAt']);
    }
    
    // Access allowlist — admin manages, users can read own + create via invite
    match /path_builder_access/{email} {
      // Admin can do anything
      allow read, write: if isAdmin();
      // Users can read their own access doc
      allow get: if request.auth != null && request.auth.token.email == email;
      // Users can create their own access entry (when consuming invite)
      allow create: if request.auth != null && request.auth.token.email == email;
    }
    
    // Default deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
